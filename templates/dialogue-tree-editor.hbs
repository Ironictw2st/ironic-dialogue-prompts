<style>
  /* === Tree Editor Layout === */
  .tree-editor { overflow: hidden; }
  .tree-editor .editor-container {
    display: grid;
    grid-template-columns: 1fr 380px;
    height: 100%;
    gap: 0;
    position: relative; /* for overlay bar */
  }
  .tree-editor .editor-container.no-panel { grid-template-columns: 1fr; }

  /* === Canvas Area === */
  .tree-editor .canvas-area {
    position: relative;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  .tree-editor .canvas-wrapper {
    flex: 1;
    position: relative;
    overflow: hidden;
    min-height: 0;
  }

  /* === SVG Canvas === */
  .tree-editor svg.tree-canvas {
    width: 100%;
    height: 100%;
    cursor: grab;
    display: block;
  }
  .tree-editor svg.tree-canvas:active { cursor: grabbing; }

  /* === Canvas Instructions === */
  .tree-editor .canvas-instructions {
    position: absolute;
    bottom: 56px; /* lifted above bottom bar */
    left: 8px;
    background: rgba(0,0,0,0.7);
    color: #999;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 10px;
    z-index: 5;
    pointer-events: none;
  }
  .tree-editor .canvas-instructions kbd {
    background: #444;
    padding: 1px 4px;
    border-radius: 2px;
    font-family: monospace;
    font-size: 10px;
  }

  /* === OVERLAY Bottom Bar (spans over sidebar) === */
  .tree-editor .bottom-bar {
    position: absolute;
    left: 0;
    right: 0;        /* span full width, including sidebar */
    bottom: 0;
    z-index: 9999;   /* above panel */
    pointer-events: auto;
  }

  /* === Bottom Toolbar === */
  .tree-editor .canvas-toolbar {
    display: flex;
    gap: 8px;
    padding: 10px 12px;
    background: rgba(0,0,0,0.88);
    border-top: 1px solid #444;
    align-items: center;
    flex-wrap: nowrap;
    flex-shrink: 0;
  }
  .tree-editor .canvas-toolbar button {
    background: rgba(255,255,255,0.12);
    border: 1px solid #555;
    border-radius: 6px;
    padding: 8px 14px;
    cursor: pointer;
    font-size: 12px;
    color: #ddd;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .tree-editor .canvas-toolbar button:hover {
    background: rgba(255,255,255,0.25);
    border-color: #888;
    color: #fff;
  }
  .tree-editor .canvas-toolbar button i { margin-right: 6px; }
  .tree-editor .canvas-toolbar .spacer { flex: 1; min-width: 10px; }

  .tree-editor .canvas-toolbar .dirty-badge {
    background: #e74c3c;
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: bold;
  }
  .tree-editor .npc-name {
    color: #fff;
    font-weight: bold;
    font-size: 13px;
    padding: 6px 10px;
    background: rgba(74,144,217,0.28);
    border-radius: 6px;
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .tree-editor .icon-btn {
    padding: 8px 10px;
    width: 42px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .tree-editor .icon-btn i { margin-right: 0; }

  /* === Edges === */
  .tree-editor .tree-edge {
    stroke: #4a90d9;
    stroke-width: 2px;
    fill: none;
    pointer-events: none;
  }
  .tree-editor .tree-edge.edge-always { stroke: #4a90d9; }
  .tree-editor .tree-edge.edge-pass   { stroke: #2ecc71; }
  .tree-editor .tree-edge.edge-fail   { stroke: #e74c3c; }
  .tree-editor .tree-edge.to-end,
  .tree-editor .tree-edge.to-action { stroke-dasharray: 5,3; }

  .tree-editor .edge-label {
    font-size: 11px;
    fill: #fff;
    paint-order: stroke;
    stroke: #1a1a2e;
    stroke-width: 3px;
    pointer-events: none;
  }
  .tree-editor .connect-line {
    stroke: #2ecc71;
    stroke-width: 3px;
    stroke-dasharray: 8,4;
    pointer-events: none;
  }

  /* === Nodes === */
  .tree-editor .tree-node { cursor: pointer; transition: filter 0.15s; }
  .tree-editor .tree-node:hover { filter: brightness(1.15); }
  .tree-editor .tree-node.selected .node-bg {
    stroke-width: 4px !important;
    filter: drop-shadow(0 0 8px rgba(255,255,255,0.5));
  }
  .tree-editor .node-bg { stroke-width: 2px; rx: 12; ry: 12; }
  .tree-editor .node-title { fill: #fff; font-size: 12px; font-weight: bold; text-anchor: middle; }
  .tree-editor .node-preview { fill: rgba(255,255,255,0.7); font-size: 10px; text-anchor: middle; }
  .tree-editor .node-badge { font-size: 9px; fill: #fff; text-anchor: middle; }
  .tree-editor .node-badge-bg { fill: rgba(0,0,0,0.3); }

  /* === Option Ports === */
  .tree-editor .option-port {
    fill: #3498db;
    stroke: #fff;
    stroke-width: 2px;
    cursor: crosshair;
    transition: all 0.15s;
  }
  .tree-editor .option-port:hover { filter: brightness(1.3); r: 8; }
  .tree-editor .option-port.option-node { fill: #3498db; }
  .tree-editor .option-port.option-end { fill: #e74c3c; }
  .tree-editor .option-port.option-shop { fill: #9b59b6; }
  .tree-editor .option-port.option-combat { fill: #e67e22; }
  .tree-editor .option-port.option-stay { fill: #95a5a6; }

  /* === Pseudo Nodes === */
  .tree-editor .pseudo-node .node-bg { fill: #444; stroke: #888; stroke-dasharray: 4,2; }
  .tree-editor .pseudo-node.end-node .node-bg { fill: #5c1a1a; stroke: #e74c3c; }
  .tree-editor .pseudo-node.action-node .node-bg { fill: #3c1a5c; stroke: #9b59b6; }

  /* === Panel === */
  .tree-editor .edit-panel {
    background: #f5f5f5;
    border-left: 3px solid #4a90d9;
    padding: 12px;
    overflow-y: auto;
    height: 100%;
    box-sizing: border-box;
    position: relative;
    z-index: 1; /* bar overlays this */
    padding-bottom: 70px; /* keep panel content above bar */
  }

  .tree-editor .panel-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid #ddd;
  }
  .tree-editor .panel-header h3 {
    margin: 0;
    flex: 1;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .tree-editor .panel-header .close-btn {
    background: none;
    width: 48px;
    border: none;
    font-size: 14px;
    cursor: pointer;
    color: #999;
    padding: 4px 6px;
    line-height: 1;
  }
  .tree-editor .panel-header .close-btn:hover { color: #e74c3c; }

  .tree-editor .panel-section {
    margin-bottom: 16px;
    background: #fff;
    border-radius: 8px;
    padding: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  .tree-editor .panel-section h4 {
    margin: 0 0 8px 0;
    font-size: 13px;
    color: #555;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .tree-editor .field-row { margin-bottom: 8px; }
  .tree-editor .field-row label {
    display: block;
    font-size: 12px;
    color: #666;
    margin-bottom: 2px;
  }
  .tree-editor .field-row input,
  .tree-editor .field-row select,
  .tree-editor .field-row textarea {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 13px;
    box-sizing: border-box;
  }
  .tree-editor .field-row textarea { min-height: 80px; resize: vertical; }
  .tree-editor .field-row input:focus,
  .tree-editor .field-row select:focus,
  .tree-editor .field-row textarea:focus {
    outline: none;
    border-color: #4a90d9;
    box-shadow: 0 0 0 2px rgba(74,144,217,0.2);
  }

  .tree-editor .inline-fields { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .tree-editor .inline-fields-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }

  .tree-editor .option-card {
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 10px;
  }
  .tree-editor .option-card .option-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 8px;
  }
  .tree-editor .option-card .option-header .opt-num {
    background: #4a90d9;
    color: white;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
  }
  .tree-editor .option-card .option-header .opt-title { flex: 1; font-weight: 600; font-size: 13px; }
  .tree-editor .option-card .del-opt-btn {
    background: none;
    border: none;
    color: #999;
    cursor: pointer;
    font-size: 14px;
  }
  .tree-editor .option-card .del-opt-btn:hover { color: #e74c3c; }

  .tree-editor .collapsible-header {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    font-size: 12px;
    color: #666;
    margin-top: 8px;
  }
  .tree-editor .collapsible-header i { transition: transform 0.2s; }
  .tree-editor .collapsible-header.collapsed i { transform: rotate(-90deg); }
  .tree-editor .collapsible-content { margin-top: 6px; padding-left: 8px; border-left: 2px solid #ddd; }
  .tree-editor .collapsible-content.hidden { display: none; }

  .tree-editor .result-row {
    background: #f0f0f0;
    border-radius: 4px;
    padding: 8px;
    padding-top: 24px;
    margin-bottom: 6px;
    position: relative;
  }
  .tree-editor .result-row .del-res-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    background: #e74c3c;
    border: none;
    color: #fff;
    cursor: pointer;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 3px;
    line-height: 1.2;
  }
  .tree-editor .result-row .del-res-btn:hover { background: #c0392b; }

  .tree-editor .btn-small {
    background: #4a90d9;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 4px 10px;
    font-size: 12px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .tree-editor .btn-small:hover { background: #357abd; }
  .tree-editor .btn-danger { background: #e74c3c; }
  .tree-editor .btn-danger:hover { background: #c0392b; }

  .tree-editor .panel-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #ddd;
  }

  .tree-editor .help-text {
    font-size: 11px;
    color: #888;
    margin-top: 4px;
    font-style: italic;
  }
</style>

<div class="editor-container {{#unless selectedNode}}no-panel{{/unless}}">
  <!-- Canvas Area -->
  <div class="canvas-area">
    <div class="canvas-wrapper">
      <svg class="tree-canvas" viewBox="0 0 {{width}} {{height}}" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <marker id="arrowhead-always" markerWidth="10" markerHeight="8" refX="9" refY="4" orient="auto">
            <polygon points="0,0 10,4 0,8" fill="#4a90d9" />
          </marker>
          <marker id="arrowhead-pass" markerWidth="10" markerHeight="8" refX="9" refY="4" orient="auto">
            <polygon points="0,0 10,4 0,8" fill="#2ecc71" />
          </marker>
          <marker id="arrowhead-fail" markerWidth="10" markerHeight="8" refX="9" refY="4" orient="auto">
            <polygon points="0,0 10,4 0,8" fill="#e74c3c" />
          </marker>
        </defs>

        <line class="connect-line" x1="0" y1="0" x2="0" y2="0" style="display:none;" />

        {{#each edges as |e|}}
          <line class="tree-edge edge-{{#if e.kind}}{{e.kind}}{{else}}always{{/if}}"
                data-from="{{e.from}}" data-to="{{e.to}}"
                x1="{{e.x1}}" y1="{{e.y1}}" x2="{{e.x2}}" y2="{{e.y2}}"
                marker-end="url(#arrowhead-{{#if e.kind}}{{e.kind}}{{else}}always{{/if}})" />
          <text class="edge-label" x="{{e.labelX}}" y="{{e.labelY}}">{{e.label}}</text>
        {{/each}}

        {{#each nodes as |n|}}
          <g class="tree-node {{#if n.isStart}}is-start{{/if}} {{#if n.isSelected}}selected{{/if}}"
             data-id="{{n.id}}" transform="translate({{n.x}},{{n.y}})">
            <rect class="node-bg" x="-70" y="-35" width="140" height="70"
                  style="fill: {{n.colorBg}}; stroke: {{n.colorBorder}};"></rect>
            <text class="node-title" y="-12">{{truncate n.id 14}}</text>
            <text class="node-preview" y="6">
              {{#if n.text}}{{truncate n.text 18}}{{else}}(empty){{/if}}
            </text>
            {{#if n.isStart}}
              <rect class="node-badge-bg" x="-22" y="14" width="44" height="16" rx="8" ry="8"></rect>
              <text class="node-badge" y="25">START</text>
            {{/if}}

            {{#each n.options as |o idx|}}
              <g class="option-port-group">
                <circle class="option-port option-{{o.targetType}}"
                        data-nid="{{../id}}" data-oid="{{o.id}}"
                        cx="{{o.portX}}" cy="{{o.portY}}" r="8"
                        title="{{o.label}}{{#if (eq o.targetType 'end')}} → END{{/if}}{{#if (eq o.targetType 'shop')}} → SHOP{{/if}}{{#if (eq o.targetType 'combat')}} → COMBAT{{/if}}">
                </circle>
                <text class="port-number" x="{{o.portX}}" y="{{o.portY}}"
                      text-anchor="middle" dominant-baseline="central"
                      style="fill: #fff; font-size: 9px; font-weight: bold; pointer-events: none;">{{add idx 1}}</text>
              </g>
              {{#if (eq o.targetType 'end')}}
                <text class="port-label" x="{{o.labelX}}" y="{{o.labelY}}" style="fill: #e74c3c; font-size: 9px; font-weight: bold;">END</text>
              {{/if}}
              {{#if (eq o.targetType 'shop')}}
                <text class="port-label" x="{{o.labelX}}" y="{{o.labelY}}" style="fill: #9b59b6; font-size: 9px; font-weight: bold;">SHOP</text>
              {{/if}}
              {{#if (eq o.targetType 'combat')}}
                <text class="port-label" x="{{o.labelX}}" y="{{o.labelY}}" style="fill: #e67e22; font-size: 9px; font-weight: bold;">FIGHT</text>
              {{/if}}
            {{/each}}
          </g>
        {{/each}}
      </svg>

      <div class="canvas-instructions">
        <kbd>Click</kbd> Select &nbsp;
        <kbd>Drag</kbd> Move &nbsp;
        <kbd>Shift+Drag</kbd> Pan &nbsp;
        <kbd>Ctrl+Scroll</kbd> Zoom
      </div>
    </div>
  </div>

  <!-- Edit Panel -->
  {{#if selectedNode}}
  <div class="edit-panel">
    <div class="panel-header">
      <h3><i class="fas fa-edit"></i> Edit Node</h3>
      <button class="close-btn" data-action="close-panel"><i class="fas fa-times"></i></button>
    </div>

    <div class="panel-section">
      <h4>Node Properties</h4>
      <div class="field-row">
        <label>Node ID</label>
        <input type="text" class="panel-node-id" value="{{selectedNode.id}}">
      </div>
      <div class="field-row">
        <label>Speaker</label>
        <input type="text" class="panel-node-speaker" value="{{selectedNode.speaker}}">
      </div>
      <div class="field-row">
        <label>Dialogue Text</label>
        <textarea class="panel-node-text">{{selectedNode.text}}</textarea>
      </div>
      {{#if (eq selectedNode.id ../start)}}
        <p class="help-text"><i class="fas fa-star"></i> This is the starting node</p>
      {{else}}
        <button type="button" class="btn-small" data-action="set-start">
          <i class="fas fa-star"></i> Set as Start
        </button>
      {{/if}}
    </div>

    <div class="panel-section">
      <h4>Options ({{selectedNode.options.length}})</h4>

      {{#each selectedNode.options as |opt idx|}}
      <div class="option-card">
        <div class="option-header">
          <span class="opt-num">{{add idx 1}}</span>
          <span class="opt-title">{{opt.label}}</span>
          <button type="button" class="del-opt-btn" data-action="del-option" data-oid="{{opt.id}}">
            <i class="fas fa-trash"></i>
          </button>
        </div>

        <div class="inline-fields">
          <div class="field-row">
            <label>Label</label>
            <input type="text" class="panel-opt-label" data-oid="{{opt.id}}" value="{{opt.label}}">
          </div>
          <div class="field-row">
            <label>Next Node</label>
            {{#with opt}}
            <select class="panel-opt-next" data-oid="{{id}}">
              <option value="">(stay)</option>
              {{#each @root.allNodeIds as |nid|}}
                <option value="{{nid}}" {{#if (eq nid ../next)}}selected{{/if}}>{{nid}}</option>
              {{/each}}
              <option value="END" {{#if (eq next "END")}}selected{{/if}}>END</option>
            </select>
            {{/with}}
          </div>
        </div>

        <div class="field-row" style="margin-top: 8px;">
          <label style="display: flex; align-items: center; gap: 6px;">
            <input type="checkbox" class="panel-opt-hidden" data-oid="{{opt.id}}" {{#if opt.hidden}}checked{{/if}}>
            Hidden (Passive Check)
          </label>
          <p class="help-text" style="margin-top: 2px;">Option hidden until player passively passes the requirement check</p>
        </div>

        <div class="collapsible-header" onclick="this.classList.toggle('collapsed');this.nextElementSibling.classList.toggle('hidden');">
          <i class="fas fa-chevron-down"></i> Requirement
        </div>
        <div class="collapsible-content">
          <div class="field-row">
            <label>Type</label>
            <select class="panel-req-type" data-oid="{{opt.id}}">
              <option value="">None</option>
              <option value="ability" {{#if (eq opt.requirement.type "ability")}}selected{{/if}}>Ability ≥</option>
              <option value="skill" {{#if (eq opt.requirement.type "skill")}}selected{{/if}}>Skill Check</option>
              <option value="race" {{#if (eq opt.requirement.type "race")}}selected{{/if}}>Race</option>
              <option value="language" {{#if (eq opt.requirement.type "language")}}selected{{/if}}>Language</option>
              <option value="spell" {{#if (eq opt.requirement.type "spell")}}selected{{/if}}>Known Spell</option>
              <option value="item" {{#if (eq opt.requirement.type "item")}}selected{{/if}}>Has Item</option>
              <option value="flag" {{#if (eq opt.requirement.type "flag")}}selected{{/if}}>Flag</option>
              <option value="gmonly" {{#if (eq opt.requirement.type "gmonly")}}selected{{/if}}>GM Only</option>
            </select>
          </div>

          {{#if opt.requirement}}
            {{#if (eq opt.requirement.type "ability")}}
              <div class="field-row">
                <label>Ability</label>
                <select class="panel-req-field" data-oid="{{opt.id}}" data-field="key">
                  <option value="str" {{#if (eq opt.requirement.key "str")}}selected{{/if}}>Strength</option>
                  <option value="dex" {{#if (eq opt.requirement.key "dex")}}selected{{/if}}>Dexterity</option>
                  <option value="con" {{#if (eq opt.requirement.key "con")}}selected{{/if}}>Constitution</option>
                  <option value="int" {{#if (eq opt.requirement.key "int")}}selected{{/if}}>Intelligence</option>
                  <option value="wis" {{#if (eq opt.requirement.key "wis")}}selected{{/if}}>Wisdom</option>
                  <option value="cha" {{#if (eq opt.requirement.key "cha")}}selected{{/if}}>Charisma</option>
                </select>
              </div>
              <div class="inline-fields">
                <div class="field-row">
                  <label>DC / Minimum</label>
                  <input type="number" class="panel-req-field" data-oid="{{opt.id}}" data-field="value" value="{{opt.requirement.value}}" placeholder="10">
                </div>
                <div class="field-row">
                  <label style="display: flex; align-items: center; gap: 6px; margin-top: 18px;">
                    <input type="checkbox" class="panel-req-field" data-oid="{{opt.id}}" data-field="roll" {{#if opt.requirement.roll}}checked{{/if}}>
                    Requires Roll
                  </label>
                </div>
              </div>
              <p class="help-text">{{#if opt.requirement.roll}}Player must roll and beat the DC{{else}}Checks raw ability score ≥ value{{/if}}</p>
            {{/if}}

            {{#if (eq opt.requirement.type "skill")}}
              <div class="field-row">
                <label>Skill</label>
                <select class="panel-req-field" data-oid="{{opt.id}}" data-field="key">
                  <option value="acr" {{#if (eq opt.requirement.key "acr")}}selected{{/if}}>Acrobatics</option>
                  <option value="ani" {{#if (eq opt.requirement.key "ani")}}selected{{/if}}>Animal Handling</option>
                  <option value="arc" {{#if (eq opt.requirement.key "arc")}}selected{{/if}}>Arcana</option>
                  <option value="ath" {{#if (eq opt.requirement.key "ath")}}selected{{/if}}>Athletics</option>
                  <option value="dec" {{#if (eq opt.requirement.key "dec")}}selected{{/if}}>Deception</option>
                  <option value="his" {{#if (eq opt.requirement.key "his")}}selected{{/if}}>History</option>
                  <option value="ins" {{#if (eq opt.requirement.key "ins")}}selected{{/if}}>Insight</option>
                  <option value="itm" {{#if (eq opt.requirement.key "itm")}}selected{{/if}}>Intimidation</option>
                  <option value="inv" {{#if (eq opt.requirement.key "inv")}}selected{{/if}}>Investigation</option>
                  <option value="med" {{#if (eq opt.requirement.key "med")}}selected{{/if}}>Medicine</option>
                  <option value="nat" {{#if (eq opt.requirement.key "nat")}}selected{{/if}}>Nature</option>
                  <option value="prc" {{#if (eq opt.requirement.key "prc")}}selected{{/if}}>Perception</option>
                  <option value="prf" {{#if (eq opt.requirement.key "prf")}}selected{{/if}}>Performance</option>
                  <option value="per" {{#if (eq opt.requirement.key "per")}}selected{{/if}}>Persuasion</option>
                  <option value="rel" {{#if (eq opt.requirement.key "rel")}}selected{{/if}}>Religion</option>
                  <option value="slt" {{#if (eq opt.requirement.key "slt")}}selected{{/if}}>Sleight of Hand</option>
                  <option value="ste" {{#if (eq opt.requirement.key "ste")}}selected{{/if}}>Stealth</option>
                  <option value="sur" {{#if (eq opt.requirement.key "sur")}}selected{{/if}}>Survival</option>
                </select>
              </div>
              <div class="field-row">
                <label>DC</label>
                <input type="number" class="panel-req-field" data-oid="{{opt.id}}" data-field="value" value="{{opt.requirement.value}}" placeholder="10">
              </div>
              <p class="help-text">Player must roll a skill check and beat the DC</p>
            {{/if}}

            {{#if (eq opt.requirement.type "race")}}
              <div class="field-row">
                <label>Race Name</label>
                <input type="text" class="panel-req-field" data-oid="{{opt.id}}" data-field="value" value="{{opt.requirement.value}}" placeholder="e.g. Elf, Human, Dwarf">
              </div>
              <p class="help-text">Checks if player's race contains this text (case-insensitive)</p>
            {{/if}}

            {{#if (eq opt.requirement.type "language")}}
              <div class="field-row">
                <label>Language(s)</label>
                <input type="text" class="panel-req-field" data-oid="{{opt.id}}" data-field="value" value="{{opt.requirement.value}}" placeholder="e.g. Elvish, Dwarvish">
              </div>
              <p class="help-text">Comma-separated list. Player must know at least one of these languages.</p>
            {{/if}}

            {{#if (eq opt.requirement.type "spell")}}
              <div class="field-row">
                <label>Spell Name</label>
                <input type="text" class="panel-req-field" data-oid="{{opt.id}}" data-field="value" value="{{opt.requirement.value}}">
              </div>
            {{/if}}

            {{#if (eq opt.requirement.type "item")}}
              <div class="field-row">
                <label>Item Name</label>
                <input type="text" class="panel-req-field" data-oid="{{opt.id}}" data-field="value" value="{{opt.requirement.value}}">
              </div>
            {{/if}}

            {{#if (eq opt.requirement.type "flag")}}
              <div class="inline-fields-3">
                <div class="field-row">
                  <label>Flag Key</label>
                  <input type="text" class="panel-req-field" data-oid="{{opt.id}}" data-field="key" value="{{opt.requirement.key}}">
                </div>
                <div class="field-row">
                  <label>Op</label>
                  <select class="panel-req-field" data-oid="{{opt.id}}" data-field="op">
                    {{#each (array "==" "!=" "in" "has") as |op|}}
                      <option value="{{op}}" {{#if (eq ../opt.requirement.op op)}}selected{{/if}}>{{op}}</option>
                    {{/each}}
                  </select>
                </div>
                <div class="field-row">
                  <label>Value</label>
                  <input type="text" class="panel-req-field" data-oid="{{opt.id}}" data-field="value" value="{{opt.requirement.value}}">
                </div>
              </div>
            {{/if}}
          {{/if}}
        </div>

        <div class="collapsible-header" onclick="this.classList.toggle('collapsed');this.nextElementSibling.classList.toggle('hidden');">
          <i class="fas fa-chevron-down"></i> Results ({{opt.results.length}})
        </div>
        <div class="collapsible-content">
          {{#each opt.results as |r ridx|}}
          <div class="result-row" style="{{#if (eq r.on 'pass')}}border-left: 3px solid #28a745;{{else if (eq r.on 'fail')}}border-left: 3px solid #dc3545;{{/if}}">
            <button type="button" class="del-res-btn panel-res-del" data-oid="{{../id}}" data-ridx="{{ridx}}">
              <i class="fas fa-times"></i>
            </button>
            <div class="field-row">
              <label>Type</label>
              <select class="panel-res-type" data-oid="{{../id}}" data-ridx="{{ridx}}">
                <option value="goto" {{#if (eq r.type "goto")}}selected{{/if}}>Go To Node</option>
                <option value="openTrade" {{#if (eq r.type "openTrade")}}selected{{/if}}>Open Trade</option>
                <option value="openShop" {{#if (eq r.type "openShop")}}selected{{/if}}>Open Shop</option>
                <option value="startCombat" {{#if (eq r.type "startCombat")}}selected{{/if}}>Start Combat</option>
                <option value="giveItem" {{#if (eq r.type "giveItem")}}selected{{/if}}>Give Item</option>
                <option value="removeItem" {{#if (eq r.type "removeItem")}}selected{{/if}}>Remove Item</option>
                <option value="setFlag" {{#if (eq r.type "setFlag")}}selected{{/if}}>Set Flag</option>
                <option value="unsetFlag" {{#if (eq r.type "unsetFlag")}}selected{{/if}}>Unset Flag</option>
                <option value="macro" {{#if (eq r.type "macro")}}selected{{/if}}>Run Macro</option>
                <option value="giveRelation" {{#if (eq r.type "giveRelation")}}selected{{/if}}>Adjust Relation</option>
                <option value="ends" {{#if (eq r.type "ends")}}selected{{/if}}>End Dialogue</option>
              </select>
            </div>
            {{#if (eq r.type "goto")}}
            <div class="field-row">
              <label>Target Node</label>
              <select class="panel-res-field" data-oid="{{../id}}" data-ridx="{{ridx}}" data-field="value">
                <option value="">Select...</option>
                {{#each @root.allNodeIds as |nid|}}
                  <option value="{{nid}}" {{#if (eq nid ../value)}}selected{{/if}}>{{nid}}</option>
                {{/each}}
              </select>
            </div>
            {{/if}}
            {{#if (eq r.type "giveItem")}}
            <div class="field-row">
              <label>Item Name</label>
              <input type="text" class="panel-res-field" data-oid="{{../id}}" data-ridx="{{ridx}}" data-field="value" value="{{r.value}}">
            </div>
            {{/if}}
            {{#if (eq r.type "removeItem")}}
            <div class="field-row">
              <label>Item Name</label>
              <input type="text" class="panel-res-field" data-oid="{{../id}}" data-ridx="{{ridx}}" data-field="value" value="{{r.value}}">
            </div>
            {{/if}}
            {{#if (eq r.type "setFlag")}}
            <div class="inline-fields">
              <div class="field-row">
                <label>Flag Key</label>
                <input type="text" class="panel-res-field" data-oid="{{../id}}" data-ridx="{{ridx}}" data-field="key" value="{{r.key}}">
              </div>
              <div class="field-row">
                <label>Value</label>
                <input type="text" class="panel-res-field" data-oid="{{../id}}" data-ridx="{{ridx}}" data-field="value" value="{{r.value}}">
              </div>
            </div>
            {{/if}}
            {{#if (eq r.type "unsetFlag")}}
            <div class="field-row">
              <label>Flag Key</label>
              <input type="text" class="panel-res-field" data-oid="{{../id}}" data-ridx="{{ridx}}" data-field="key" value="{{r.key}}">
            </div>
            {{/if}}
            {{#if (eq r.type "macro")}}
            <div class="field-row">
              <label>Macro Name</label>
              <input type="text" class="panel-res-field" data-oid="{{../id}}" data-ridx="{{ridx}}" data-field="value" value="{{r.value}}">
            </div>
            {{/if}}
            {{#if (eq r.type "giveRelation")}}
            <div class="field-row">
              <label>Amount (+/-)</label>
              <input type="number" class="panel-res-field" data-oid="{{../id}}" data-ridx="{{ridx}}" data-field="value" value="{{r.value}}">
            </div>
            {{/if}}
            {{#if ../needsRoll}}
            <div class="field-row">
              <label>Run On</label>
              <select class="panel-res-field" data-oid="{{../id}}" data-ridx="{{ridx}}" data-field="on">
                <option value="always" {{#unless r.on}}selected{{/unless}}{{#if (eq r.on "always")}}selected{{/if}}>Always</option>
                <option value="pass" {{#if (eq r.on "pass")}}selected{{/if}}>✓ On Pass</option>
                <option value="fail" {{#if (eq r.on "fail")}}selected{{/if}}>✗ On Fail</option>
              </select>
            </div>
            {{/if}}
          </div>
          {{/each}}
          <button type="button" class="btn-small panel-res-add" data-oid="{{opt.id}}">
            <i class="fas fa-plus"></i> Add Result
          </button>
        </div>
      </div>
      {{/each}}

      <button type="button" class="btn-small" data-action="add-option">
        <i class="fas fa-plus"></i> Add Option
      </button>
    </div>

    <div class="panel-actions">
      {{#unless (eq selectedNode.id ../start)}}
      <button type="button" class="btn-small btn-danger" data-action="delete-node">
        <i class="fas fa-trash"></i> Delete Node
      </button>
      {{/unless}}
    </div>
  </div>
  {{/if}}

  <!-- Overlay Bottom Bar (LAST so it overlays everything) -->
  <div class="bottom-bar">
    <div class="canvas-toolbar">
      <span class="npc-name"><i class="fas fa-user"></i> {{npcName}}</span>

      <div class="spacer"></div>

      <button type="button" data-action="add-node"><i class="fas fa-plus"></i> Node</button>
      <button type="button" data-action="auto-layout"><i class="fas fa-project-diagram"></i> Layout</button>
      <button type="button" data-action="fit-view"><i class="fas fa-compress-arrows-alt"></i> Fit</button>

      <div class="spacer"></div>

      <button type="button" class="icon-btn" data-action="export-json" title="Export dialogue as JSON"><i class="fas fa-download"></i></button>
      <button type="button" class="icon-btn" data-action="import-json" title="Import dialogue from JSON"><i class="fas fa-upload"></i></button>
      <button type="button" class="icon-btn" data-action="presets" title="Load/Save Presets"><i class="fas fa-bookmark"></i></button>

      <div class="spacer"></div>

      {{#if dirty}}<span class="dirty-badge">Unsaved</span>{{/if}}

      <button type="button" data-action="preview"><i class="fas fa-eye"></i> Preview</button>
      <button type="button" data-action="open-editor"><i class="fas fa-list"></i> List</button>
      <button type="button" data-action="save"><i class="fas fa-save"></i> Save</button>
    </div>
  </div>
</div>
