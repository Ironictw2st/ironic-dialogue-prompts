<style>
  .ironic-dialogue .graph-wrap { width: 100%; height: 100%; }
  .ironic-dialogue svg { width: 100%; height: 100%; background: var(--color-bg, transparent); }
  
  /* Base edge style */
  .ironic-dialogue .edge { stroke-width: 2px; fill: none; }
  
  /* Edge colors by runOn type */
  .ironic-dialogue .edge-always { stroke: #3498db; } /* blue */
  .ironic-dialogue .edge-pass { stroke: #2ecc71; }   /* green */
  .ironic-dialogue .edge-fail { stroke: #e74c3c; }   /* red */
  
  .ironic-dialogue .edge-label { 
    font-size: 12px; 
    fill: #222; 
    paint-order: stroke; 
    stroke: #fff; 
    stroke-width: 4px; 
  }
  .ironic-dialogue .dg-node { cursor: pointer; }
  .ironic-dialogue .node-label { font-weight: 700; font-size: 12px; }
  .ironic-dialogue .badge { font-size: 11px; opacity: .9; }
  .ironic-dialogue .node-rect { rx: 10; ry: 10; fill: #e9e9ee; stroke: #666; stroke-width: 1.2px; }
  .ironic-dialogue .node-start .node-rect { fill: #d9f5e0; stroke: #2e7d32; }
  .ironic-dialogue .node-end .node-rect { fill: #ffe3e3; stroke: #c62828; }
  .ironic-dialogue .node-action .node-rect { fill: #ece2ff; stroke: #7b1fa2; }
  .ironic-dialogue .legend { font-size: 12px; opacity: .8; }
</style>

<div class="graph-wrap">
  <svg viewBox="0 0 {{width}} {{height}}" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <!-- Arrow markers for each runOn type -->
      <marker id="arrow-always" markerWidth="10" markerHeight="8" refX="10" refY="4" orient="auto">
        <polygon points="0,0 10,4 0,8" fill="#3498db" />
      </marker>
      <marker id="arrow-pass" markerWidth="10" markerHeight="8" refX="10" refY="4" orient="auto">
        <polygon points="0,0 10,4 0,8" fill="#2ecc71" />
      </marker>
      <marker id="arrow-fail" markerWidth="10" markerHeight="8" refX="10" refY="4" orient="auto">
        <polygon points="0,0 10,4 0,8" fill="#e74c3c" />
      </marker>
    </defs>

    <!-- Edges with colored arrows based on runOn -->
    {{#each edges as |e|}}
      <line class="edge edge-{{e.runOn}}" 
            x1="{{e.x1}}" y1="{{e.y1}}" 
            x2="{{e.x2}}" y2="{{e.y2}}" 
            marker-end="url(#arrow-{{e.runOn}})"/>
      <text class="edge-label" x="{{calcMid e.x1 e.x2}}" y="{{calcMid e.y1 e.y2 -6}}">{{e.label}}</text>
    {{/each}}

    <!-- Nodes -->
    {{#each nodes as |n|}}
      <g class="dg-node node-{{n.type}} {{#if n.isStart}}node-start{{/if}}" transform="translate({{n.x}},{{n.y}})">
        <rect class="node-rect" width="{{n.w}}" height="{{n.h}}"/>
        <text class="node-label" x="{{divide n.w 2}}" y="22" text-anchor="middle">{{n.label}}</text>
        <text class="badge" x="{{divide n.w 2}}" y="40" text-anchor="middle">{{n.id}}</text>
      </g>
    {{/each}}

    <!-- Legend -->
    <g class="legend" transform="translate(12,12)">
      <rect x="0" y="0" width="200" height="100" rx="8" ry="8" fill="#fff" stroke="#aaa"/>
      
      <!-- Node types -->
      <g transform="translate(8,16)">
        <rect x="0" y="-10" width="18" height="18" rx="4" ry="4" class="node-rect"/>
        <text x="26" y="2">Dialogue Node</text>
      </g>
      <g transform="translate(8,38)">
        <rect x="0" y="-10" width="18" height="18" rx="4" ry="4" class="node-rect node-start"/>
        <text x="26" y="2">Start</text>
      </g>
      <g transform="translate(100,38)">
        <rect x="0" y="-10" width="18" height="18" rx="4" ry="4" class="node-rect node-end"/>
        <text x="26" y="2">End</text>
      </g>
      
      <!-- Edge colors legend -->
      <g transform="translate(8,60)">
        <line x1="0" y1="0" x2="18" y2="0" stroke="#3498db" stroke-width="3"/>
        <text x="26" y="4">Always</text>
      </g>
      <g transform="translate(8,78)">
        <line x1="0" y1="0" x2="18" y2="0" stroke="#2ecc71" stroke-width="3"/>
        <text x="26" y="4">Pass</text>
      </g>
      <g transform="translate(100,78)">
        <line x1="0" y1="0" x2="18" y2="0" stroke="#e74c3c" stroke-width="3"/>
        <text x="26" y="4">Fail</text>
      </g>
    </g>
  </svg>
</div>